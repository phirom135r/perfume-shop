<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>POS</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .product-card img { height: 160px; object-fit: cover; background: #f3f4f6; }
        .sticky-col { position: sticky; top: 12px; }
        .qty-btn { width: 36px; height: 36px; padding: 0; }
    </style>
</head>
<body class="bg-light" >

<div class="container-fluid py-3" layout:fragment="content">
    <div class="row g-3">

        <!-- LEFT: Products -->
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">

                    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                        <h5 class="mb-0 me-2">POS</h5>

                        <div class="ms-auto d-flex gap-2 flex-wrap">
                            <input id="q" class="form-control" style="min-width:240px" placeholder="Search products..."/>
                            <button class="btn btn-primary" id="btnSearch">Search</button>
                        </div>
                    </div>

                    <div id="productsGrid" class="row g-3"></div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
                        <div class="small text-muted" id="pageInfo">Page 1</div>
                        <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT: Cart + Checkout -->
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm sticky-col">
                <div class="card-header bg-primary text-white d-flex align-items-center gap-2">
                    <span class="fw-bold">Shopping Cart</span>
                    <span class="ms-auto badge bg-light text-dark">USD ($)</span>
                </div>

                <div class="card-body">

                    <div id="cartList" class="vstack gap-3"></div>
                    <hr/>

                    <div class="d-flex justify-content-between">
                        <div class="text-muted">Subtotal</div>
                        <div class="fw-semibold">$<span id="subtotal">0.00</span></div>
                    </div>

                    <div class="d-flex justify-content-between mt-2">
                        <div class="text-muted">Extra Discount</div>
                        <div class="fw-semibold text-danger">- $<span id="discountShow">0.00</span></div>
                    </div>

                    <div class="d-flex justify-content-between mt-3 fs-5">
                        <div class="fw-bold">Total</div>
                        <div class="fw-bold text-primary">$<span id="total">0.00</span></div>
                    </div>

                    <hr/>

                    <!-- Customer form -->
                    <div class="mb-2">
                        <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                        <input id="customerName" class="form-control" placeholder="Enter customer name"/>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Phone (optional)</label>
                        <input id="phone" class="form-control" placeholder="Enter phone number"/>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Address (optional for POS)</label>
                        <input id="address" class="form-control" placeholder="Enter address"/>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Extra Discount ($)</label>
                        <input id="extraDiscount" class="form-control" value="0" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select id="paymentMethod" class="form-select">
                            <option value="CASH">CASH</option>
                            <option value="KHQR">KHQR</option>
                        </select>
                    </div>

                    <button id="btnComplete" class="btn btn-success w-100">
                        âœ… Complete Order
                    </button>

                    <button id="btnClear" class="btn btn-outline-danger w-100 mt-2">
                        ðŸ—‘ Clear Cart
                    </button>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // -----------------------------
    // Simple POS State
    // -----------------------------
    let page = 0;
    const size = 9;
    let q = "";
    const cart = new Map(); // productId -> {id,name,price,image,qty}

    // -----------------------------
    // Helpers
    // -----------------------------
    function money(n) {
        const x = Number(n || 0);
        return x.toFixed(2);
    }
    function bdToNumber(v) {
        // if server returns "12.34" as string -> Number works
        return Number(v || 0);
    }

    function cartSubtotal() {
        let s = 0;
        for (const it of cart.values()) s += bdToNumber(it.price) * it.qty;
        return s;
    }

    function discountValue() {
        const raw = (document.getElementById("extraDiscount").value || "0").replace(",", "");
        const d = Number(raw);
        return isNaN(d) ? 0 : Math.max(0, d);
    }

    function cartTotal() {
        const sub = cartSubtotal();
        const d = Math.min(discountValue(), sub);
        return sub - d;
    }

    function updateSummary() {
        const sub = cartSubtotal();
        const d = Math.min(discountValue(), sub);
        const total = sub - d;

        document.getElementById("subtotal").textContent = money(sub);
        document.getElementById("discountShow").textContent = money(d);
        document.getElementById("total").textContent = money(total);
    }

    function renderCart() {
        const wrap = document.getElementById("cartList");
        wrap.innerHTML = "";

        if (cart.size === 0) {
            wrap.innerHTML = `<div class="text-muted small">Cart is empty.</div>`;
            updateSummary();
            return;
        }

        for (const it of cart.values()) {
            const row = document.createElement("div");
            row.className = "border rounded p-2 d-flex gap-2 align-items-center";

            const img = it.image ? it.image : "https://via.placeholder.com/80x60?text=No+Image";

            row.innerHTML = `
        <img src="${img}" style="width:70px;height:55px;object-fit:cover;border-radius:8px;background:#f3f4f6" alt="img"/>
        <div class="flex-grow-1">
          <div class="fw-semibold">${it.name}</div>
          <div class="small text-muted">$${money(bdToNumber(it.price))}</div>
          <div class="d-flex align-items-center gap-2 mt-1">
            <button class="btn btn-outline-secondary qty-btn" data-act="dec" data-id="${it.id}">-</button>
            <div class="fw-bold">${it.qty}</div>
            <button class="btn btn-outline-secondary qty-btn" data-act="inc" data-id="${it.id}">+</button>
            <button class="btn btn-outline-danger btn-sm ms-auto" data-act="remove" data-id="${it.id}">x</button>
          </div>
        </div>
      `;
            wrap.appendChild(row);
        }

        wrap.querySelectorAll("button").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = Number(btn.getAttribute("data-id"));
                const act = btn.getAttribute("data-act");
                if (!cart.has(id)) return;

                const item = cart.get(id);
                if (act === "inc") item.qty++;
                if (act === "dec") item.qty = Math.max(1, item.qty - 1);
                if (act === "remove") cart.delete(id);

                cart.set(id, item);
                renderCart();
            });
        });

        updateSummary();
    }

    // -----------------------------
    // Load products (You need an API)
    // -----------------------------
    async function loadProducts() {
        // âœ… IMPORTANT:
        // You must have an endpoint that returns products JSON with pagination.
        // Example expected response:
        // { content:[{id,name,price,image,stock}], page:0, totalPages:5 }
        //
        // If you already have AdminProductApiController, add an endpoint like:
        // GET /admin/api/products/pos?q=...&page=...&size=...
        const url = `/admin/api/products/pos?q=${encodeURIComponent(q)}&page=${page}&size=${size}`;

        const res = await fetch(url, { cache:"no-store" });
        if (!res.ok) {
            document.getElementById("productsGrid").innerHTML =
                `<div class="text-danger">POS products API not found: ${url}</div>`;
            return;
        }

        const data = await res.json();
        const list = data.content || [];

        const grid = document.getElementById("productsGrid");
        grid.innerHTML = "";

        for (const p of list) {
            const col = document.createElement("div");
            col.className = "col-12 col-md-6 col-lg-4";

            const img = p.image ? p.image : "https://via.placeholder.com/600x400?text=No+Image";
            const stockBadge = (p.stock <= 5)
                ? `<span class="badge bg-warning text-dark">Low Stock</span>`
                : `<span class="badge bg-success">High Stock</span>`;

            col.innerHTML = `
        <div class="card product-card h-100 shadow-sm">
          <img src="${img}" class="card-img-top" alt="product"/>
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div class="fw-bold">${p.name}</div>
              ${stockBadge}
            </div>
            <div class="text-muted small">${p.brand || ""}</div>

            <div class="mt-2">
              <div class="fs-5 fw-bold text-danger">$${money(bdToNumber(p.price))}</div>
              <div class="small text-muted">Stock: ${p.stock}</div>
            </div>

            <button class="btn btn-primary mt-auto w-100"
                    ${p.stock <= 0 ? "disabled" : ""}
                    data-add="${p.id}">
              ðŸ›’ Add to Cart
            </button>
          </div>
        </div>
      `;
            grid.appendChild(col);
        }

        grid.querySelectorAll("[data-add]").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = Number(btn.getAttribute("data-add"));
                const p = list.find(x => x.id === id);
                if (!p) return;

                const existing = cart.get(id);
                if (existing) existing.qty++;
                else cart.set(id, { id: p.id, name: p.name, price: p.price, image: p.image, qty: 1 });

                renderCart();
                Swal.fire({ toast:true, position:"top-end", icon:"success", title:"Added to cart!", showConfirmButton:false, timer:1200 });
            });
        });

        document.getElementById("pageInfo").textContent = `Page ${page + 1} / ${data.totalPages || 1}`;
    }

    // -----------------------------
    // Checkout Ajax
    // -----------------------------
    async function completeOrder() {
        if (cart.size === 0) {
            await Swal.fire({ icon:"warning", title:"Cart is empty" });
            return;
        }

        const customerName = document.getElementById("customerName").value.trim();
        if (!customerName) {
            await Swal.fire({ icon:"warning", title:"Customer name is required" });
            return;
        }

        const payload = {
            customerName,
            phone: document.getElementById("phone").value.trim(),
            address: document.getElementById("address").value.trim(), // optional for POS
            paymentMethod: document.getElementById("paymentMethod").value,
            extraDiscount: (document.getElementById("extraDiscount").value || "0").replace(",", ""),
            items: Array.from(cart.values()).map(it => ({ productId: it.id, qty: it.qty }))
        };

        const res = await fetch("/admin/pos/checkout", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const txt = await res.text();
            await Swal.fire({ icon:"error", title:"Checkout failed", text: txt.substring(0, 200) });
            return;
        }

        const data = await res.json();

        // If KHQR => redirect to QR page
        if (data.redirectUrl) {
            await Swal.fire({ icon:"success", title:"Order created!", text: `Order: ${data.orderNo}`, timer: 1000, showConfirmButton:false });
            window.location.href = data.redirectUrl;
            return;
        }

        // CASH complete
        await Swal.fire({ icon:"success", title:"Order completed!", text: `Order: ${data.orderNo}` });
        cart.clear();
        renderCart();
        // optional redirect
        // window.location.href = "/admin/orders";
    }

    // -----------------------------
    // Events
    // -----------------------------
    document.getElementById("btnSearch").addEventListener("click", () => {
        q = document.getElementById("q").value.trim();
        page = 0;
        loadProducts();
    });

    document.getElementById("prevBtn").addEventListener("click", () => {
        page = Math.max(0, page - 1);
        loadProducts();
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
        page = page + 1;
        loadProducts();
    });

    document.getElementById("extraDiscount").addEventListener("input", () => {
        updateSummary();
    });

    document.getElementById("btnClear").addEventListener("click", async () => {
        const ok = await Swal.fire({ icon:"question", title:"Clear cart?", showCancelButton:true });
        if (!ok.isConfirmed) return;
        cart.clear();
        renderCart();
    });

    document.getElementById("btnComplete").addEventListener("click", completeOrder);

    // init
    renderCart();
    loadProducts();
</script>

</body>
</html>