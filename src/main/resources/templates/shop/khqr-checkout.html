<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHQR Checkout</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="container py-4">

<h3 class="mb-2">Scan KHQR to Pay</h3>

<p class="mb-3">
    Order: <b th:text="${orderNo}">ORD...</b>
    â€” Amount: <b>$<span th:text="${amount}">0.00</span></b>
</p>

<div id="qrcode" class="my-3"></div>

<div class="small text-muted">
    MD5: <span th:text="${md5}">md5_here</span>
</div>

<hr>

<div class="d-flex align-items-center gap-3">
    <div class="fw-bold">Time left:</div>
    <div id="countdown" class="fs-4 text-danger" th:text="${expireSeconds}">120</div>
    <div class="text-muted">seconds</div>
</div>

<div class="mt-3">
    <span class="badge bg-secondary" id="statusBadge">PENDING</span>
    <span class="small text-muted ms-2" id="statusHint"></span>
</div>

<div class="mt-4 d-flex gap-2">
    <a href="/" class="btn btn-outline-secondary btn-sm">Back</a>
    <button class="btn btn-outline-primary btn-sm" id="btnRetry" type="button">Retry Check</button>
</div>

<script th:inline="javascript">
    const khqrString = /*[[${khqrString}]]*/ "";
    const paymentId = /*[[${paymentId}]]*/ 0;
    let timeLeft = /*[[${expireSeconds}]]*/ 120;

    const countdownEl = document.getElementById("countdown");
    const statusBadge = document.getElementById("statusBadge");
    const statusHint = document.getElementById("statusHint");
    const btnRetry = document.getElementById("btnRetry");

    // render QR
    try {
        new QRCode(document.getElementById("qrcode"), { text: khqrString, width: 280, height: 280 });
    } catch (e) {
        statusBadge.textContent = "ERROR";
        statusBadge.className = "badge bg-danger";
        statusHint.textContent = "QR render failed.";
    }

    function setBadge(status) {
        statusBadge.textContent = status;
        if (status === "PAID") {
            statusBadge.className = "badge bg-success";
            statusHint.textContent = "Payment verified.";
        } else if (status === "FAILED") {
            statusBadge.className = "badge bg-danger";
            statusHint.textContent = "Payment failed.";
        } else if (status === "EXPIRED") {
            statusBadge.className = "badge bg-dark";
            statusHint.textContent = "QR expired.";
        } else if (status === "ERROR") {
            statusBadge.className = "badge bg-warning text-dark";
            statusHint.textContent = "Verify error. Retrying...";
        } else {
            statusBadge.className = "badge bg-secondary";
            statusHint.textContent = "";
        }
    }

    async function checkStatusOnce() {
        try {
            const res = await fetch(`/payments/check/${paymentId}`, { cache: "no-store" });
            if (!res.ok) { setBadge("ERROR"); return "ERROR"; }
            const data = await res.json();
            const status = (data && data.status) ? String(data.status).toUpperCase() : "PENDING";
            setBadge(status);
            return status;
        } catch (e) {
            setBadge("ERROR");
            return "ERROR";
        }
    }

    setBadge("PENDING");

    const timer = setInterval(async () => {
        timeLeft--;
        countdownEl.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(timer);
            setBadge("EXPIRED");
            await Swal.fire({ icon: "warning", title: "Expired!", text: "QR code expired." });
            window.location.href = "/";
            return;
        }

        const status = await checkStatusOnce();

        if (status === "PAID") {
            clearInterval(timer);
            await Swal.fire({ icon: "success", title: "Payment Successfully!", timer: 1500, showConfirmButton: false });
            window.location.href = "/"; // or /admin/orders for POS
            return;
        }

        if (status === "FAILED") {
            clearInterval(timer);
            await Swal.fire({ icon: "error", title: "Payment Failed!", text: "Please try again." });
            window.location.href = "/";
            return;
        }

    }, 1000);

    btnRetry.addEventListener("click", async () => {
        await checkStatusOnce();
    });
</script>

</body>
</html>